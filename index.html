<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LLAMA WebChat –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π</title>

<link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.css" rel="stylesheet"/>
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #e0e0e0; margin: 0; padding: 0; }
.chat-container { max-width: 900px; margin: 30px auto; background: #f9f9f9; border-radius: 12px; padding: 20px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
.message { margin-bottom: 12px; opacity: 0; transform: translateY(10px); transition: all 0.3s ease; }
.message.show { opacity: 1; transform: translateY(0); }
.user { text-align: right; }
.assistant { text-align: left; color: #333; }
.input-area { display: flex; flex-direction: column; margin-top: 15px; }
textarea { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #ccc; resize: vertical; font-family: inherit; font-size: 14px; }
button { padding: 10px 18px; margin-top: 10px; border: none; background: #4CAF50; color: #fff; border-radius: 8px; cursor: pointer; align-self: flex-end; font-weight: bold; }
button:hover { background: #45a049; }
#login-container { text-align: center; margin-top: 120px; }
#chat-container { display: none; }
#chat-final { background: #ffffff; border-left: 5px solid #4CAF50; border-radius: 8px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); max-height: 700px; overflow-y: auto; }
#chat-analysis { background: #f0f4ff; border-left: 5px solid #2196F3; border-radius: 8px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); max-height: 300px; overflow-y: auto; }
.channel-label { font-weight: bold; margin-bottom: 8px; }
table { border-collapse: collapse; width: 100%; margin: 12px 0; font-size: 14px; }
table, th, td { border: 1px solid #ccc; }
th, td { padding: 8px 12px; text-align: left; }
th { background: #f2f2f2; }
pre { background: #2d2d2d; color: #f8f8f2; padding: 12px; border-radius: 6px; overflow-x: auto; }
code { font-family: 'Courier New', Courier, monospace; }
</style>
</head>
<body>

<div id="login-container">
  <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
  <input id="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
  <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
  <button onclick="login()">–í–æ–π—Ç–∏</button>
  <p id="login-error" style="color:red;"></p>
</div>

<div id="chat-container" class="chat-container">
  <div id="chat-final"></div>
  <div id="chat-analysis"></div>
  <div class="input-area">
    <textarea id="prompt" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="3"></textarea>
    <button onclick="sendPrompt()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
const API_URL = 'http://localhost:8080/v1/chat/completions';
const USER = { name: '', token: '' };

const MESSAGES = [
  { role: 'system', content: `
–í—ã ‚Äî –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –û—Ç–≤–µ—á–∞–π—Ç–µ –∫–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
**–í–°–ï –æ—Ç–≤–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown.**
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–¥–æ–≤—ã–µ –±–ª–æ–∫–∏ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —è–∑—ã–∫–∞.
–§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: <|channel|>final<|message|>...
–ê–Ω–∞–ª–∏–∑: <|channel|>analysis<|message|>...
` }
];

function login() {
  const user = document.getElementById('username').value.trim();
  const pass = document.getElementById('password').value.trim();
  if (user && pass && pass === '1234') {
    USER.name = user;
    USER.token = btoa(user + ':' + pass);
    document.getElementById('login-container').style.display = 'none';
    document.getElementById('chat-container').style.display = 'flex';
    renderChat();
  } else {
    document.getElementById('login-error').textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å (–ø–∞—Ä–æ–ª—å: 1234)';
  }
}

const input = document.getElementById('prompt');
input.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendPrompt();
  }
});

marked.setOptions({
  highlight: function(code, lang) {
    if (Prism.languages[lang]) return Prism.highlight(code, Prism.languages[lang], lang);
    return code;
  },
  gfm: true,
  breaks: true
});

function formatMarkdown(text) {
  return marked.parse(text);
}

async function sendPrompt() {
  const text = input.value.trim();
  if (!text) return;
  input.value = '';

  MESSAGES.push({ 
    role: 'user', 
    content: text + "\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown, –≤–∫–ª—é—á–∞—è –∫–æ–¥–æ–≤—ã–µ –±–ª–æ–∫–∏." 
  });

  renderChat();

  const response = await fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ messages: MESSAGES, max_tokens: 512 })
  });

  const data = await response.json();
  if (data.choices && data.choices.length > 0) {
    let content = data.choices[0].message.content;
    let finalText = '', analysisText = '';

    const finalMatch = content.match(/<\|channel\|>final<\|message\|>([\s\S]*?)(?=(<\|channel\|>|$))/);
    const analysisMatch = content.match(/<\|channel\|>analysis<\|message\|>([\s\S]*?)(?=(<\|channel\|>|$))/);

    if (finalMatch) finalText = finalMatch[1].trim();
    else finalText = content.trim(); // –µ—Å–ª–∏ final –Ω–µ—Ç, –±–µ—Ä–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç

    if (analysisMatch) analysisText = analysisMatch[1].trim();

    if (finalText) {
      MESSAGES.push({ role: 'assistant', content: finalText });
      renderChat();
    }

    const analysisContainer = document.getElementById('chat-analysis');
    analysisContainer.innerHTML = '';
    if (analysisText) {
      const label = document.createElement('div');
      label.className = 'channel-label';
      label.textContent = '–ê–Ω–∞–ª–∏–∑:';
      analysisContainer.appendChild(label);

      const contentDiv = document.createElement('div');
      contentDiv.innerHTML = formatMarkdown(analysisText);
      analysisContainer.appendChild(contentDiv);

      analysisContainer.scrollTop = analysisContainer.scrollHeight;
      Prism.highlightAll();
    }
  }
}

function renderChat() {
  const chat = document.getElementById('chat-final');
  chat.innerHTML = '';
  MESSAGES.forEach(m => {
    if (m.role === 'system') return;
    const div = document.createElement('div');
    div.className = 'message ' + m.role;
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º Markdown + Prism –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
    const mdDiv = document.createElement('div');
    mdDiv.innerHTML = formatMarkdown((m.role === 'user' ? `üßë ${m.content}` : `ü§ñ ${m.content}`));
    div.appendChild(mdDiv);

    chat.appendChild(div);
    setTimeout(() => div.classList.add('show'), 50);
  });
  chat.scrollTop = chat.scrollHeight;
  Prism.highlightAll();
}
</script>
</body>
</html>
